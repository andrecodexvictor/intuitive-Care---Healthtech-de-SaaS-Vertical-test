# =============================================================
# docker-compose.yml - Orquestração Completa
# =============================================================
# EXECUÇÃO:
#   docker-compose up -d
#
# COM ENV FILE CUSTOMIZADO:
#   docker-compose --env-file config/env/.env.docker up -d
#
# SERVIÇOS:
#   - mysql: Banco de dados MySQL 8.0
#   - api: Backend FastAPI (Python)
#   - frontend: Dashboard Vue.js (Nginx)
#
# ACESSO:
#   - Frontend: http://localhost:3000
#   - API: http://localhost:8000
#   - API Docs: http://localhost:8000/docs
#
# REDE INTERNA (evita conflitos no Windows):
#   - Subnet: 172.28.0.0/16
#   - mysql:    172.28.1.10
#   - api:      172.28.1.20
#   - frontend: 172.28.1.30
# =============================================================

services:
  # =========================================================
  # MySQL 8.0 - Banco de Dados
  # =========================================================
  mysql:
    image: mysql:8.0
    container_name: intuitive_care_mysql
    hostname: mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${DATABASE_PASSWORD:-intuitive_care_2024}
      MYSQL_DATABASE: ${DATABASE_NAME:-intuitive_care_test}
      MYSQL_CHARACTER_SET_SERVER: utf8mb4
      MYSQL_COLLATION_SERVER: utf8mb4_unicode_ci
      # Evita problemas de autenticação no Windows
      MYSQL_ROOT_HOST: "%"
    ports:
      - "3307:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./sql/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-u", "root", "-p${DATABASE_PASSWORD:-intuitive_care_2024}" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      intuitive_network:
        ipv4_address: 172.28.1.10
        aliases:
          - mysql
          - database
          - db

  # =========================================================
  # API FastAPI - Backend Python
  # =========================================================
  api:
    build:
      context: .
      dockerfile: docker/api/Dockerfile
    container_name: intuitive_care_api
    hostname: api
    restart: unless-stopped
    environment:
      # Usa IP fixo para evitar problemas de DNS no Windows
      DATABASE_HOST: 172.28.1.10
      DATABASE_PORT: 3306
      DATABASE_USER: root
      DATABASE_PASSWORD: ${DATABASE_PASSWORD:-intuitive_care_2024}
      DATABASE_NAME: ${DATABASE_NAME:-intuitive_care_test}
      API_DEBUG: ${API_DEBUG:-false}
      ENVIRONMENT: ${ENVIRONMENT:-production}
      # IPs internos + localhost para CORS
      CORS_ORIGINS: "http://localhost:3000,http://127.0.0.1:3000,http://172.28.1.30,http://frontend"
    ports:
      - "8000:8000"
    volumes:
      - ./src:/app/src
      - ./data:/app/data
      - ./logs:/app/logs
    extra_hosts:
      # Fallback se DNS interno falhar
      - "mysql:172.28.1.10"
      - "database:172.28.1.10"
    depends_on:
      mysql:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://127.0.0.1:8000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      intuitive_network:
        ipv4_address: 172.28.1.20
        aliases:
          - api
          - backend

  # =========================================================
  # Frontend Vue.js - Dashboard
  # =========================================================
  frontend:
    build:
      context: .
      dockerfile: docker/frontend/Dockerfile
    container_name: intuitive_care_frontend
    hostname: frontend
    restart: unless-stopped
    ports:
      - "3000:80"
    volumes:
      - ./docker/frontend/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    extra_hosts:
      # Garante resolução do nome da API
      - "api:172.28.1.20"
      - "backend:172.28.1.20"
    depends_on:
      - api
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://127.0.0.1/" ]
      interval: 30s
      timeout: 5s
      retries: 3
    networks:
      intuitive_network:
        ipv4_address: 172.28.1.30
        aliases:
          - frontend
          - web

  # =========================================================
  # ETL Runner - Executa uma vez para popular dados
  # =========================================================
  etl:
    build:
      context: .
      dockerfile: docker/api/Dockerfile
    container_name: intuitive_care_etl
    hostname: etl
    environment:
      # Usa IP fixo para conexão estável
      DATABASE_HOST: 172.28.1.10
      DATABASE_PORT: 3306
      DATABASE_USER: root
      DATABASE_PASSWORD: ${DATABASE_PASSWORD:-intuitive_care_2024}
      DATABASE_NAME: ${DATABASE_NAME:-intuitive_care_test}
    volumes:
      - ./data:/app/data
    extra_hosts:
      - "mysql:172.28.1.10"
    depends_on:
      mysql:
        condition: service_healthy
    command: [ "python", "run_etl.py", "--trimestres", "3" ]
    profiles:
      - etl # Só roda quando explicitamente chamado: docker-compose --profile etl up etl
    networks:
      intuitive_network:
        ipv4_address: 172.28.1.40

# =========================================================
# Volumes Persistentes
# =========================================================
volumes:
  mysql_data:
    driver: local

# =========================================================
# Rede Interna - Subnet Customizada
# =========================================================
# DECISÃO: Usar subnet fixa 172.28.0.0/16
# JUSTIFICATIVA:
#   - Evita conflitos com redes Docker padrão (172.17.x.x)
#   - IPs fixos eliminam problemas de DNS no Windows
#   - Faixa privada RFC 1918 (não conflita com redes corporativas)
#   - Aliases DNS para flexibilidade
# =========================================================
networks:
  intuitive_network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.28.0.0/16
          gateway: 172.28.0.1
